<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Card Cost Extractor (IMPROVED - Crops Cost Circle)</title>
  <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .subtitle {
      opacity: 0.9;
      font-size: 1.1em;
    }
    
    .improvement-banner {
      background: #48bb78;
      color: white;
      padding: 15px;
      text-align: center;
      font-weight: 600;
      font-size: 1.1em;
    }
    
    .content {
      padding: 30px;
    }
    
    .drop-zone {
      border: 3px dashed #667eea;
      border-radius: 15px;
      padding: 60px 20px;
      text-align: center;
      background: #f8f9ff;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 30px;
    }
    
    .drop-zone:hover {
      border-color: #764ba2;
      background: #f0f2ff;
      transform: scale(1.02);
    }
    
    .drop-zone.dragover {
      border-color: #764ba2;
      background: #e8ebff;
      transform: scale(1.05);
    }
    
    .drop-icon {
      font-size: 4em;
      margin-bottom: 20px;
    }
    
    .drop-text {
      font-size: 1.3em;
      color: #667eea;
      font-weight: 600;
    }
    
    .drop-subtext {
      color: #888;
      margin-top: 10px;
    }
    
    #fileInput {
      display: none;
    }
    
    .results {
      margin-top: 30px;
    }
    
    .card-result {
      background: #f8f9ff;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 20px;
      transition: all 0.3s;
    }
    
    .card-result:hover {
      transform: translateX(5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .card-preview-container {
      display: flex;
      gap: 10px;
    }
    
    .card-preview {
      width: 100px;
      height: 140px;
      object-fit: cover;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .card-crop {
      width: 60px;
      height: 70px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #48bb78;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .card-info {
      flex: 1;
    }
    
    .card-name {
      font-size: 1.2em;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }
    
    .card-details {
      color: #666;
      font-size: 0.95em;
    }
    
    .cost-badge {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 1.1em;
      min-width: 60px;
      text-align: center;
    }
    
    .cost-badge.success {
      background: #48bb78;
    }
    
    .cost-badge.warning {
      background: #ed8936;
    }
    
    .cost-badge.error {
      background: #f56565;
    }
    
    .confidence {
      font-size: 0.85em;
      color: #888;
      margin-top: 5px;
    }
    
    .progress {
      background: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      height: 30px;
      margin: 20px 0;
    }
    
    .progress-bar {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      height: 100%;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    
    .stat-value {
      font-size: 2.5em;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .stat-label {
      opacity: 0.9;
      font-size: 1.1em;
    }
    
    .code-output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 25px;
      border-radius: 15px;
      font-family: 'Courier New', monospace;
      font-size: 0.95em;
      overflow-x: auto;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    
    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .hidden {
      display: none;
    }
    
    .status {
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      font-weight: 500;
    }
    
    .status.info {
      background: #bee3f8;
      color: #2c5282;
    }
    
    .status.success {
      background: #c6f6d5;
      color: #22543d;
    }
    
    .status.warning {
      background: #feebc8;
      color: #7c2d12;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸŽ´ Card Cost Extractor</h1>
      <div class="subtitle">IMPROVED - Crops just the cost circle!</div>
    </header>
    
    <div class="improvement-banner">
      âœ¨ NEW: Adjustable crop position + Color preserved + High contrast + Digits only! âœ¨
    </div>
    
    <div class="content">
      <div class="crop-controls" style="background: #f8f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
        <h3 style="margin-bottom: 15px;">ðŸŽ¯ Adjust Crop Position (Fine-tune for your cards)</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">X Position (from left): <span id="xValue">25</span>px</label>
            <input type="range" id="cropX" min="0" max="100" value="25" style="width: 100%;" oninput="updateCropConfig()">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Y Position (from top): <span id="yValue">30</span>px</label>
            <input type="range" id="cropY" min="0" max="100" value="30" style="width: 100%;" oninput="updateCropConfig()">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Width: <span id="widthValue">50</span>px</label>
            <input type="range" id="cropWidth" min="20" max="100" value="50" style="width: 100%;" oninput="updateCropConfig()">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Height: <span id="heightValue">60</span>px</label>
            <input type="range" id="cropHeight" min="20" max="120" value="60" style="width: 100%;" oninput="updateCropConfig()">
          </div>
        </div>
        <p style="margin-top: 15px; color: #666; font-size: 0.9em;">ðŸ’¡ Tip: Process 1 card first, look at the cropped preview, then adjust sliders and try again!</p>
      </div>
      
      <div class="drop-zone" id="dropZone">
        <div class="drop-icon">ðŸ“¤</div>
        <div class="drop-text">Drop card images here</div>
        <div class="drop-subtext">or click to select files</div>
        <input type="file" id="fileInput" multiple accept="image/*">
      </div>
      
      <div id="progressSection" class="hidden">
        <div class="progress">
          <div class="progress-bar" id="progressBar">0%</div>
        </div>
        <div id="statusMessage" class="status info"></div>
      </div>
      
      <div id="statsSection" class="stats hidden">
        <div class="stat-card">
          <div class="stat-value" id="totalCards">0</div>
          <div class="stat-label">Total Cards</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="successfulCards">0</div>
          <div class="stat-label">Extracted</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="avgConfidence">0%</div>
          <div class="stat-label">Avg Confidence</div>
        </div>
      </div>
      
      <div id="results" class="results"></div>
      
      <div id="outputSection" class="hidden">
        <h2>Generated Code</h2>
        <p style="color: #666; margin-bottom: 15px;">ðŸ’¡ Tip: Click any cost number above to edit it manually before downloading!</p>
        <div class="button-group">
          <button class="button" onclick="copyCode()">ðŸ“‹ Copy Code</button>
          <button class="button" onclick="downloadCode()">ðŸ’¾ Download File</button>
          <button class="button" onclick="reset()">ðŸ”„ Process More Cards</button>
        </div>
        <pre class="code-output" id="codeOutput"></pre>
      </div>
    </div>
  </div>

  <script>
    let results = [];
    let processedCount = 0;
    let totalFiles = 0;

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const progressSection = document.getElementById('progressSection');
    const progressBar = document.getElementById('progressBar');
    const statusMessage = document.getElementById('statusMessage');
    const statsSection = document.getElementById('statsSection');
    const resultsDiv = document.getElementById('results');
    const outputSection = document.getElementById('outputSection');
    const codeOutput = document.getElementById('codeOutput');

    // CROP CONFIG - Adjustable via sliders
    let CROP_CONFIG = { 
      x: 25,      // Start further right (skip left border)
      y: 30,      // Start further down (skip top border)
      width: 50,  // Much narrower (just the digit)
      height: 60  // Much shorter (just the digit)
    };

    // Update crop config from sliders
    function updateCropConfig() {
      CROP_CONFIG.x = parseInt(document.getElementById('cropX').value);
      CROP_CONFIG.y = parseInt(document.getElementById('cropY').value);
      CROP_CONFIG.width = parseInt(document.getElementById('cropWidth').value);
      CROP_CONFIG.height = parseInt(document.getElementById('cropHeight').value);
      
      document.getElementById('xValue').textContent = CROP_CONFIG.x;
      document.getElementById('yValue').textContent = CROP_CONFIG.y;
      document.getElementById('widthValue').textContent = CROP_CONFIG.width;
      document.getElementById('heightValue').textContent = CROP_CONFIG.height;
    }

    // Drop zone events
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    /**
     * Crop image to just the cost circle
     */
    async function cropImage(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const reader = new FileReader();
        
        reader.onload = (e) => {
          img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = CROP_CONFIG.width;
            canvas.height = CROP_CONFIG.height;
            const ctx = canvas.getContext('2d');
            
            // Draw cropped portion
            ctx.drawImage(
              img,
              CROP_CONFIG.x, CROP_CONFIG.y, CROP_CONFIG.width, CROP_CONFIG.height,
              0, 0, CROP_CONFIG.width, CROP_CONFIG.height
            );
            
            // Keep original colors, just increase contrast
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
              // Apply high contrast to each color channel separately (R, G, B)
              for (let j = 0; j < 3; j++) {
                const value = data[i + j];
                data[i + j] = ((value / 255 - 0.5) * 2.5 + 0.5) * 255;
              }
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            canvas.toBlob(resolve, 'image/png');
          };
          img.src = e.target.result;
        };
        
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function handleFiles(files) {
      results = [];
      processedCount = 0;
      totalFiles = files.length;
      
      progressSection.classList.remove('hidden');
      statsSection.classList.add('hidden');
      outputSection.classList.add('hidden');
      resultsDiv.innerHTML = '';
      
      updateStatus(`Processing ${totalFiles} images...`);
      
      for (const file of files) {
        await processImage(file);
        processedCount++;
        updateProgress();
      }
      
      showResults();
    }

    async function processImage(file) {
      const cardName = extractCardName(file.name);
      const cardType = guessCardType(file.name);
      
      try {
        updateStatus(`Processing: ${cardName}... (cropping to cost circle)`);
        
        // Crop to just the cost circle
        const croppedBlob = await cropImage(file);
        const croppedUrl = URL.createObjectURL(croppedBlob);
        
        // Create worker with proper configuration for digits only
        const worker = await Tesseract.createWorker('eng');
        await worker.setParameters({
          tessedit_char_whitelist: '0123456789',
          tessedit_pageseg_mode: Tesseract.PSM.SINGLE_CHAR,
        });
        
        const { data } = await worker.recognize(croppedBlob);
        await worker.terminate();
        
        const text = data.text.trim();
        const confidence = data.confidence;
        const cost = parseInt(text);
        
        const result = {
          file: file,
          cardName: cardName,
          type: cardType,
          cost: !isNaN(cost) && cost >= 0 && cost <= 10 ? cost : null,
          confidence: confidence,
          raw: text,
          imageUrl: URL.createObjectURL(file),
          croppedUrl: croppedUrl
        };
        
        results.push(result);
        addResultCard(result, results.length - 1);
        
      } catch (error) {
        console.error('Error processing:', file.name, error);
        results.push({
          file: file,
          cardName: cardName,
          type: cardType,
          cost: null,
          confidence: 0,
          error: error.message,
          imageUrl: URL.createObjectURL(file),
          croppedUrl: null
        });
      }
    }

    function extractCardName(filename) {
      let name = filename.replace(/\.(png|jpg|jpeg|webp)$/i, '');
      name = name.replace(/^BP\d+-[UL]?\d+[A-Z]+[-_]?/i, '');
      name = name.replace(/[_-]/g, ' ');
      return name.trim();
    }

    function guessCardType(filename) {
      const lower = filename.toLowerCase();
      if (lower.includes('token')) return 'follower';
      if (lower.includes('spell')) return 'spell';
      if (lower.includes('amulet')) return 'amulet';
      return 'follower';
    }

    function updateProgress(percent) {
      if (percent === undefined) {
        percent = Math.round(processedCount / totalFiles * 100);
      }
      progressBar.style.width = percent + '%';
      progressBar.textContent = percent + '%';
    }

    function updateStatus(message) {
      statusMessage.textContent = message;
    }

    function addResultCard(result, index) {
      const div = document.createElement('div');
      div.className = 'card-result';
      div.dataset.index = index;
      
      const costClass = result.cost !== null 
        ? (result.confidence >= 60 ? 'success' : 'warning')
        : 'error';
      
      div.innerHTML = `
        <div class="card-preview-container">
          <img src="${result.imageUrl}" alt="${result.cardName}" class="card-preview">
          ${result.croppedUrl ? `<img src="${result.croppedUrl}" alt="Cropped" class="card-crop" title="Cropped cost circle">` : ''}
        </div>
        <div class="card-info">
          <div class="card-name">${result.cardName}</div>
          <div class="card-details">
            Type: ${result.type} | Raw OCR: "${result.raw}"
            <div class="confidence">Confidence: ${Math.round(result.confidence)}%</div>
          </div>
        </div>
        <div class="cost-badge ${costClass}">
          <input type="number" 
                 min="0" 
                 max="10" 
                 value="${result.cost !== null ? result.cost : ''}" 
                 placeholder="?"
                 style="width: 40px; text-align: center; font-size: 1.1em; font-weight: 600; border: none; background: transparent; color: white;"
                 onchange="updateCost(${index}, this.value)"
                 onclick="this.select()">
        </div>
      `;
      
      resultsDiv.appendChild(div);
    }

    function updateCost(index, value) {
      const cost = parseInt(value);
      if (!isNaN(cost) && cost >= 0 && cost <= 10) {
        results[index].cost = cost;
        generateCode();
      } else if (value === '') {
        results[index].cost = null;
        generateCode();
      }
    }

    function showResults() {
      const successful = results.filter(r => r.cost !== null);
      const avgConf = successful.length > 0
        ? successful.reduce((sum, r) => sum + r.confidence, 0) / successful.length
        : 0;
      
      document.getElementById('totalCards').textContent = results.length;
      document.getElementById('successfulCards').textContent = successful.length;
      document.getElementById('avgConfidence').textContent = Math.round(avgConf) + '%';
      
      statsSection.classList.remove('hidden');
      outputSection.classList.remove('hidden');
      
      generateCode();
      
      const statusClass = successful.length === results.length ? 'success' : 'warning';
      statusMessage.className = `status ${statusClass}`;
      statusMessage.textContent = successful.length === results.length
        ? 'âœ… All cards processed successfully!'
        : `âš ï¸ ${results.length - successful.length} cards need manual review`;
    }

    function generateCode() {
      const successful = results.filter(r => r.cost !== null);
      
      let code = '// Auto-generated card costs from IMPROVED OCR (cropped to cost circle)\n';
      code += `// Generated: ${new Date().toISOString()}\n`;
      code += `// Total: ${results.length} | Extracted: ${successful.length}\n\n`;
      code += 'export const cardCosts = {\n';
      
      for (const card of successful) {
        code += `  "${card.cardName}": { cost: ${card.cost}, type: "${card.type}" },`;
        code += ` // Confidence: ${Math.round(card.confidence)}%`;
        if (card.confidence < 60) {
          code += ' âš ï¸';
        }
        code += '\n';
      }
      
      code += '};\n';
      
      codeOutput.textContent = code;
    }

    function copyCode() {
      navigator.clipboard.writeText(codeOutput.textContent);
      alert('âœ… Code copied to clipboard!');
    }

    function downloadCode() {
      const blob = new Blob([codeOutput.textContent], { type: 'text/javascript' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'extractedCosts.js';
      a.click();
      URL.revokeObjectURL(url);
    }

    function reset() {
      results = [];
      processedCount = 0;
      totalFiles = 0;
      resultsDiv.innerHTML = '';
      progressSection.classList.add('hidden');
      statsSection.classList.add('hidden');
      outputSection.classList.add('hidden');
      fileInput.value = '';
    }
  </script>
</body>
</html>
